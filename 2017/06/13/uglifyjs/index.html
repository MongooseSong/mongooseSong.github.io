<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 丑化你的JS代码 | The Song from A Mongoose</title><meta name="description" content="丑化你的JS代码 - mongoose"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/scss/casual.css"><link rel="stylesheet" href="/css/icon.css"><link rel="search" type="application/opensearchdescription+xml" href="https://mongoosesong.github.io/atom.xml" title="The Song from A Mongoose"></head><body><div class="header"><header class="site-header"><div class="site-nav"><span class="button-toggle"></span><div class="container"><div class="nav-item"><a href="/" target="_self" data-text="home">主页</a></div><div class="nav-item"><a href="/archives" target="_self" data-text="archive">归档</a></div><div class="nav-item"><a href="/about" target="_self" data-text="about">关于</a></div><div class="nav-item"><a href="/atom.xml" target="_self" data-text="rss">订阅</a></div></div><form id="search-form" class="nav-item"><input type="text" id="local-search-input" name="q" results="0" placeholder="搜索" autocomplete="off" autocorrect="off" class="search form-control"><span onclick="resetSearch()" class="fa fa-times"> </span></form><div id="local-search-result"></div><p class="no-result">No results found</p></div></header></div><div class="main"><div class="container"><div class="content"><div class="post"><article class="post-block"><h1 class="post-title">丑化你的JS代码</h1><span class="post-date">2017年6月13日</span><span class="post-tag"><a href="/tags/前端/">前端</a><a href="/tags/开发工具/">开发工具</a></span><span class="post-review">阅读次数 : <span data-hk-page="current">-</span></span><div class="post-content"><p>UglifyJS，即压缩JavaScript代码。作为前端开发，我们通常都会在发布代码前，对HTML、CSS、JavaScript代码进行一次压缩，精简代码大小，并且防止源代码泄露。在Webpack出现后，我们可以直接用webpack.optimize.UglifyJsPlugin来进行最终的代码压缩，这篇文章会简单分析一下UglifyJS的工作原理，并说明UglifyJS到底会做什么事情。</p>
<h3 id="1-词法分析"><a href="#1-词法分析" class="headerlink" title="1. 词法分析"></a>1. 词法分析</h3><p>任何一个编译器不能避免的操作首先是对代码进行词法分析，通过逐个扫描代码字符识别到关键词、注释、操作符、变量、字符串和数字等等，一个直观的词法分析作用示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var target = 985;</div><div class="line"></div><div class="line">// 词法分析后的结果</div><div class="line">[</div><div class="line">  &quot;var&quot; : &quot;keyword&quot;,</div><div class="line">  &quot;target&quot; : &quot;identifier&quot;,</div><div class="line">  &quot;=&quot;   : &quot;assignment&quot;,</div><div class="line">  &quot;985&quot;  : &quot;integer&quot;,</div><div class="line">  &quot;;&quot;   : &quot;eos&quot; (end of statement)</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="2-语法分析"><a href="#2-语法分析" class="headerlink" title="2. 语法分析"></a>2. 语法分析</h3><p>词法分析之后就是语法分析，具体来说，就是来识别语句具体是什么意义，如果词法定义了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">主语: &quot;猫&quot; | &quot;狗&quot;;</div><div class="line">谓语: &quot;吃&quot; | &quot;喝&quot;;</div><div class="line">宾语: &quot;食物&quot; | &quot;水&quot;</div></pre></td></tr></table></figure>
<p>如果我定义一个语法是”主语 谓语 宾语”，那么“猫 喝 水”就是合法的语句，而“猫 吃 喝”虽然能通过词法检查，但是因为找不到合适的语法规则，所以会报出语法解析错误。<br>通常，我们会通过构建AST(Abstract Syntax Tree，抽象语法树)来分析语法，我们把每一个词法识别出来的字符作为树上的节点元素，这是整个编译器里面最重要的环节。<br>接上面词法分析的结果, 语法分析的结果示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  operation: &quot;=&quot;,</div><div class="line">  left: &#123;</div><div class="line">    keyword: &quot;var&quot;,</div><div class="line">    right: &quot;target&quot;</div><div class="line">  &#125;</div><div class="line">  right: &quot;985&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>常用的JS词法和语法分析工具有<a href="https://github.com/zaach/jison" target="_blank" rel="external">Jison</a>(CoffeeScript), 还有<a href="https://github.com/mishoo/cl-uglify-js" target="_blank" rel="external">Cl-Uglify-Js</a>(UglifyJS)等。</p>
<h3 id="3-UglifyJS的规则"><a href="#3-UglifyJS的规则" class="headerlink" title="3.UglifyJS的规则"></a>3.UglifyJS的规则</h3><p>本文的重点是这一部分，会列举在识别到什么样的语法时，进行什么样的精简操作。<br>不过要注意的是每个Uglify的实现都是不一样的，大家都会遵循一些基础的原则，某些情况下可以更智能的转化：</p>
<h4 id="1-变量名称的混淆原则"><a href="#1-变量名称的混淆原则" class="headerlink" title="(1) 变量名称的混淆原则"></a>(1) 变量名称的混淆原则</h4><p>规则： 只有作用域上面的变量名称可以被混淆，全局变量名称不可被混淆。<br>解释： 全局变量相关的有可能被别的文件所引用，故不能混淆。</p>
<p>规则： 函数的参数名称可以混淆。<br>解释： 函数参数本质上就是出于局部作用域上的变量，故可以混淆。</p>
<p>规则： 使用eval生成的代码不能被混淆。<br>解释： 不用解释……</p>
<p>规则： 使用了with定义的作用域内部的变量不会被混淆。<br>解释： 因为使用with定义的作用域内部，无法在编译时期确定到底访问的是哪一个变量，故不能混淆。</p>
<h4 id="2-变量名混淆的优先级"><a href="#2-变量名混淆的优先级" class="headerlink" title="(2) 变量名混淆的优先级"></a>(2) 变量名混淆的优先级</h4><p>规则： 字母优先级”etnrisouaflchpdvmgybwESxTNCkLAOM_DPHBjFIqRUzWXV”。<br>解释： 据说这样可以使GZip生成的代码体积更小。</p>
<p>规则： 当前作用域不同变量混淆后的变量名不能重复，同时混淆后的名字不能是关键字。<br>解释： 所有的混淆都是基于作用域来定了，一个作用域下混淆过的变量名要按照优先级顺序拼装。</p>
<h4 id="3-表达式的压缩"><a href="#3-表达式的压缩" class="headerlink" title="(3) 表达式的压缩"></a>(3) 表达式的压缩</h4><p>规则： 如果表达式的结果可以提前计算，并且生成体积会小于原来表达式，则可以执行提前计算。<br>举例： <code>var expr1 = 3 + 5</code> 会被压缩成 <code>var expr1 = 8</code><br>举例： <code>var expr1 = 1 / 3</code> 不会被压缩成 <code>var expr1 = 0.333333...</code>， 因为计算过后的结果长度会明显大于前面的表达式。</p>
<p>规则： true会转化成!0, false会转化成!1<br>解释： 很显然按照此种方式可以缩短2-3个字符，并且不影响后面的比较</p>
<p>规则： 利用短路特性预计算 &amp;&amp; 和 || 表达式的结果<br>举例： true &amp;&amp; say() 会被压缩成 A()</p>
<p>规则： 尽量使用二元操作符替换赋值表达式<br>举例： var a = a + b 会被压缩成 var a += b;</p>
<h4 id="4-函数的压缩"><a href="#4-函数的压缩" class="headerlink" title="(4) 函数的压缩"></a>(4) 函数的压缩</h4><p>规则： 去除没有使用的函数参数<br>举例： <code>function abc(a, b, c){ console.log(a, b) }</code> 会被压缩为 <code>function(a, b){console.log(a, b)}</code></p>
<p>规则： 去除根本不会执行的while循环：while(false){}<br>解释： 也不排除有人会写这种代码…</p>
<p>规则： while(true)变成for(;;)<br>解释： 少写4个字符…</p>
<p>规则： 多个变量定义可以合并成一句话<br>举例： <code>function A(){ var a; var b; var c;}</code> 会被压缩为 <code>function A(){var a,b,c;}</code><br>解释： 很多JS编译器都会做这种事情，因为JS本来就是有变量定义提升的功能。</p>
<p>规则： 如果if/else其中一个块为空，另一个块只有一条语句，则可以化成||或者&amp;&amp;的表达式。<br>举例： <code>if (A){ B(); }</code> 会被压缩成 <code>A&amp;&amp;B();</code></p>
<h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h3><p>其实之前自己刚接触前端时，很好奇Js代码是怎么压缩的。现在想想其实做的事情也不麻烦，主要是定义足够的语法规则，并且需要使用一些额外的变量来存放一些使用过的变量名，我们会使用BeautifyJS来格式化自己的代码，UglifyJS来压缩自己的代码，可能大家会谈很多原则用来如何优雅的写代码，我这篇文章也算从机器的角度来解释压缩的作用。</p>
</div></article></div><div class="post-paginator"><div class="post-links"><div class="post-prev"><a href="/2017/06/13/react-typescript/" class="prev">上一篇<span>使用TypeScript集成React</span></a></div><div class="post-next"><a href="/2017/06/13/react-lifecycle/" class="next">下一篇<span>React生命周期</span></a></div></div></div><div id="uyan_frame"></div></div><div class="sidebar"><div class="social-links"><ul><li class="social-link"><a href="http://github.com/littlewin-wang" target="_blank" class="link-github"><i class="icon icon-github"></i></a></li><li class="social-link"><a href="http://twitter.com/littlewin_wang" target="_blank" class="link-twitter"><i class="icon icon-twitter"></i></a></li><li class="social-link"><a href="http://weibo.com/fredinweibo" target="_blank" class="link-weibo"><i class="icon icon-weibo"></i></a></li><li class="social-link"><a href="mailto:littlewin.wang@gmail.com" target="_self" class="link-mail"><i class="icon icon-mail"></i></a></li></ul></div><div class="recent-posts widget"><h3 class="widget-title"> 近期文章</h3><div class="widget-content"><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/js-metaprog/">JavaScript元编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/13/react-typescript/">使用TypeScript集成React</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/13/uglifyjs/">丑化你的JS代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/13/react-lifecycle/">React生命周期</a></li></ul></div></div><div class="recent-comment widget"><h3 class="widget-title"> 近期评论</h3><div class="widget-content"><div id="uyan_newcmt_unit"></div></div></div><div class="tag-lists widget"><h3 class="widget-title"> 标签</h3><div class="widget-content"><a class="tag-link" href="/tags/React/">React</a> <a class="tag-link" href="/tags/前端/">前端</a> <a class="tag-link" href="/tags/开发工具/">开发工具</a></div></div><div class="archive-lists widget"><h3 class="widget-title"> 归档</h3><div class="widget-content"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">3</span></li></ul></div></div></div></div></div><footer><div class="copyright"><div class="container"><div class="col-6"><div class="site-info">© 2016 - 2017 <span class="icon icon-heart"></span> <a href="https://mongoosesong.github.io">mongoose</a><span class="sep">/</span><a href="https://hexo.io/" target="_blank">Powered by Hexo</a><span class="sep">/</span><a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">Theme by casual</a></div></div><div class="col-6"><div class="site-contact"><div class="social-links"><ul><li class="social-link"><a href="http://github.com/littlewin-wang" target="_blank" class="link-github"><i class="icon icon-github"></i></a></li><li class="social-link"><a href="http://twitter.com/littlewin_wang" target="_blank" class="link-twitter"><i class="icon icon-twitter"></i></a></li><li class="social-link"><a href="http://weibo.com/fredinweibo" target="_blank" class="link-weibo"><i class="icon icon-weibo"></i></a></li><li class="social-link"><a href="mailto:littlewin.wang@gmail.com" target="_self" class="link-mail"><i class="icon icon-mail"></i></a></li></ul></div></div></div></div></div></footer><a class="scroll-up"><span class="icon icon-up"></span></a><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/posfixed.js"></script><script src="/js/utils.js"></script><script src="/js/search.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2128137"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-92791318-1",'auto');ga('send','pageview');</script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="http://jerry-cdn.b0.upaiyun.com/hit-kounter/hit-kounter-lc-0.2.0.js"></script></body></html>